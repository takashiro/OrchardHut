{template header}

<ol class="nav">
	<li><a href="admin.php">管理面板</a></li>
	<li><a href="admin.php?mod=order">订单</a></li>
	<li>订单列表</li>
</ol>

<script type="text/javascript">
var lang = {
	order_unsorted : '{lang common order_unsorted}',
	order_sorted : '{lang common order_sorted}',
	order_delivering : '{lang common order_delivering}',
	order_in_delivery_point : '{lang common order_in_delivery_point}',
	order_received : '{lang common order_received}',
	order_rejected : '{lang common order_rejected}',
	confirm_to_mark_detail_in_stock : '您确认要将该项标记为有货吗？',
	confirm_to_mark_detail_out_of_stock : '您确认要将该项标记为缺货吗？'
};
var mod_url = '$mod_url';
var admin = {
	hasPermission : function(perm){
		{loop $_G['admin']->GetAllPermissionNames() $perm}
		if(perm == '$perm'){
			return {echo $_G['admin']->hasPermission($perm) ? 'true' : 'false'};
		}
		{/loop}
		return false;
	}
}

$(function(){
	$('#delivery_address_list').on('click', 'li .add', function(e){
		var button = $(e.target);
		var li = button.parent();
		var ul = li.parent();
		ul.append(li.clone(true));

		button.attr('class', 'remove');
		button.text('[移除]');
	});

	$('#delivery_address_list').on('click', 'li .remove', function(e){
		var button = $(e.target);
		var li = button.parent();
		li.remove();
	});

	$('#condition_form').submit(function(){
		var button = $(this).find('button[type="submit"]:focus');
		$(this).attr('target', button.val() == 'print' ? '_blank' : '_self');
	});
});
</script>

<script type="text/javascript" src="./js/datetime.js"></script>
<script type="text/javascript" src="./js/admin_order_list.js"></script>

<div class="box">
	<h1>订单管理</h1>
	<div class="content">
		<form id="condition_form" class="quick_search" action="$mod_url" method="post">
			<dl>
				<dt>订单号：</dt>
				<dd><input type="text" name="orderid" style="width:3em" /></dd>
				<dt>时间：</dt>
				<dd><input type="text" name="time_start" class="datetime" value="$time_start" /> - <input type="text" name="time_end" class="datetime" value="$time_end" /></dd>
				<dt>统计：</dt>
				<dd>{echo Template::checkbox('stat[statonly]', '仅统计', !empty($stat['statonly']))} {echo Template::checkbox('stat[item]', '物品', !empty($stat['item']))} {echo Template::checkbox('stat[totalprice]', '总价格', !empty($stat['totalprice']))}</dd>
			</dl>
			<dl>
				<dt>送货地址：</dt>
				<dd>{echo Template::tselect('delivery_address[]', $address_format, $address_components, false, isset($order_address[0]) && empty($order_address[1]) ? $order_address[0] : 0)}</dd>
				<dt>订单状态：</dt>
				<dd>
					<!--{loop $available_status $id $checked}-->
					{echo Template::checkbox("display_status[$id]", Order::$Status[$id], $checked)}
					<!--{/loop}-->
				</dd>
			</dl>
			<div class="post_buttons">
				<button type="submit" name="format" value="html">查找</button>
				<button type="submit" name="format" value="csv">导出Excel</button>
				<button type="submit" name="format" value="print">批量打印小票</button>
				<button type="submit" name="format" value="barcode">批量打印条码</button>
				<button id="multi_mark_sorted" title="批量点击本页所有[已打包]按钮">本页已打包</button>
				<button id="multi_mark_in_delivery_point" title="批量点击本页所有[到配送站]按钮">本页到配送站</button>
				<button id="multi_mark_delivering" title="批量点击本页所有[配送中]按钮">本页送货中</button>
			</div>
		</form>

		<div id="orderlist" class="list" style="font-size:10pt">
			<table>
				<thead>
					<tr>
						<td>编号</td>
						<td>库位号</td>
					<!--{loop Address::Format() $f}-->
						<td>$f[name]</td>
					<!--{/loop}-->
						<td>地址</td>
						<td>收件人</td>
						<td>历史订单</td>
						<td>物品</td>
						<td>价格</td>
						<td width="60">物流状态</td>
						<td>付款状态</td>
						<td width="100">下单时间</td>
						<td width="100">收货时间</td>
						<td width="50">操作</td>
						<td>留言</td>
					</tr>
				</thead>
				<tbody>
				<!--{if empty($stat['statonly'])}-->
					<!--{loop $orders $o}-->
					<tr primaryvalue="$o[id]">
						<td>$o[id]</td>
						<td>$o[customlabel]</td>
						<!--{loop Address::Format() $format}-->
							<td>{echo $o['address'][$format['id']]}</td>
						<!--{/loop}-->
						<td>$o[extaddress]</td>
						<td><a href="$mod_url&action=list&time_start=&time_end=&addressee=$o[addressee]">$o[addressee]</a><br /><a href="$mod_url&action=list&time_start=&time_end=&mobile=$o[mobile]">$o[mobile]</a></td>
						<td><a href="$mod_url&action=list&time_start=&time_end=&userid=$o[userid]">$o[ordernum]</a></td>
						<td>
							<ul class="order_detail{if !$_G['admin']->hasPermission('order_sort_w') || $o['status'] != Order::Unsorted} disabled{/if}">
							<!--{loop $o['detail'] $d}-->
							<li primaryvalue="$d[id]"{if $d['state'] == 1} class="outofstock"{/if}>$d[productname]<!--{if $d['subtype']}-->($d[subtype])<!--{/if}--> {echo $d['amount'] * $d['number'];}$d[amountunit]</li>
							<!--{/loop}-->
							</ul>
						</td>
						<td><span class="totalprice">$o[totalprice]</span>{echo Product::$PriceUnit}</td>
						<td>
							{echo Order::$Status[$o['status']]}
							<!--{if $o['status'] == Order::Unsorted && $_G['admin']->hasPermission('order_sort_w')}-->
							<div><a class="mark_sorted" href="{$mod_url}&action=mark_sorted&orderid=$o[id]" title="将订单标记为已打包">[已打包]</a></div>
							<!--{elseif $o['status'] == Order::Sorted && $_G['admin']->hasPermission('order_deliver_w')}-->
							<div><a class="mark_in_delivery_point" href="{$mod_url}&action=mark_indp&orderid=$o[id]" title="将订单标记为到达配送站">[到配送站]</a></div>
							<!--{elseif ($o['status'] == Order::InDeliveryPoint || $o['status'] == Order::Delivering) && $_G['admin']->hasPermission('order_deliver_w')}-->
							<!--{if $o['status'] != Order::Delivering && $o['deliverymethod'] != Order::StationDelivery}-->
							<div><a class="mark_delivering" href="{$mod_url}&action=mark_delivering&orderid=$o[id]" title="将订单标记为配送中">[配送中]</a></div>
							<!--{/if}-->
							<div><a class="mark_received" href="{$mod_url}&action=mark_received&orderid=$o[id]" title="将订单标记为已签收">[已签收]</a></div>
							<div><a class="mark_rejected" href="{$mod_url}&action=mark_rejected&orderid=$o[id]" title="将订单标记为已拒收">[已拒收]</a></div>
							<!--{/if}-->
						</td>
						<td>
							<div>{echo Order::$PaymentMethod[$o['paymentmethod']]}</div>
							<!--{if $o['alipaystate']}-->{echo AlipayNotify::$TradeState[$o['alipaystate']]}<!--{/if}-->
						</td>
						<td>{echo rdate($o['dateline'])}</td>
						<td>
						<!--{if $o['deliverymethod'] == Order::StationDelivery}-->
							配送站自提
						<!--{elseif $o['dtime_from'] && $o['dtime_to']}-->
							{echo rdate($o['dtime_from'], 'Y-m-d H:i')} - {echo rdate($o['dtime_to'], 'H:i')}
						<!--{/if}-->
						</td>
						<td>
							<a class="print" href="$mod_url&action=print&orderid=$o[id]" target="_blank">[打印]</a>
							<!--{if $o['status'] == Order::Unsorted}-->
							<br /><a class="delete" href="$mod_url&action=cancel&orderid=$o[id]">[取消]</a>
							<!--{/if}-->
						</td>
						<td style="width:10%;"><div style="font-size:9pt;max-height:100px;overflow-y:auto;">$o[message]</div></td>
					</tr>
					<!--{/loop}-->
				<!--{/if}-->
				<!--{if !empty($stat['item'])}-->
					<!--{loop $statdata['item'] $item}-->
					<tr>
						<td></td>
						<td colspan="{echo count(Address::Format()) + 1}"></td>
						<td colspan="2"></td>
						<td>$item[productname]<!--{if !empty($item['subtype'])}-->($item[subtype])<!--{/if}--> $item[num] $item[amountunit]</td>
						<td>{$item[totalprice]}{echo Product::$PriceUnit}</td>
						<td colspan="4"></td>
					</tr>
					<!--{/loop}-->
				<!--{/if}-->
				<!--{if !empty($stat['totalprice'])}-->
					<tr>
						<td>总计</td>
						<td colspan="{echo count(Address::Format()) + 1}"></td>
						<td colspan="2"></td>
						<td>$pagenum 个订单</td>
						<td>{$statdata['totalprice']}{echo Product::$PriceUnit}</td>
						<td colspan="5"></td>
					</tr>
				<!--{/if}-->
				</tbody>
			</table>
		</div>
	</div>
</div>

<!--{if empty($stat['statonly'])}-->
{echo Template::mpage($pagenum, $page, $limit, $mod_url.'&display_status='.implode(',', $display_status).'&'.http_build_query(array('delivery_address' => $delivery_address)).'&time_start='.$time_start.'&time_end='.$time_end.'&'.http_build_query(array('stat' => $stat)).'&mobile='.$mobile.'&addressee='.$addressee.'&administrator='.$administrator.'&userid='.$userid)}
<!--{/if}-->

{template footer}
