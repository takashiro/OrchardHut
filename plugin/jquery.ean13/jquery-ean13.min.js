/*
* Copyright (c) 2014 Johannes Mittendorfer (http://johannes-mittendorfer.com)
* Licensed under the MIT License (LICENSE.txt).
*
* Version 2.1.1
* Build 2014-10-07
*/

(function(d,b,a){var e,c;c="EAN13";"use strict";e=(function(){f.prototype.settings={};f.prototype.init=function(){var h,g;if(this.number.length===12){h=this.generateCheckDigit(this.number);this.number+=h}if(this.number.length===13){if(this.validate()){this.settings.onValid.call()}else{this.settings.onInvalid.call()}g=this.getCode();return this.draw(g)}else{return this.settings.onError.call()}};f.prototype.getCode=function(){var p,g,o,k,h,j,n,m,l;n=["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"];m=["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"];l=["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"];o=["xxxxxx","xxyxyy","xxyyxy","xxyyyx","xyxxyy","xyyxxy","xyyyxx","xyxyxy","xyxyyx","xyyxyx"];g="";p=o[parseInt(this.number.substr(0,1),10)].split("");j=this.number.substr(1);h=j.split("");k=0;while(k<6){if(p[k]==="x"){g+=n[h[k]]}else{g+=m[h[k]]}k++}k=6;while(k<12){g+=l[h[k]];k++}return g};f.prototype.clear=function(g){return g.clearRect(0,0,this.element.width,this.element.height)};f.prototype.draw=function(h){var o,s,j,v,p,t,r,k,w,m,q,g,u,l,n;r={prefix_offset:0.06,font_stretch:0.073,border_line_height_number:0.9,border_line_height:1,line_height:0.9,font_size:0.15,font_y:1.03,text_offset:4.5};g=(this.settings.prefix?this.element.width-(this.element.width*r.prefix_offset):this.element.width);if(this.settings.number){o=r.border_line_height_number*this.element.height;v=r.line_height*o}else{o=r.border_line_height*this.element.height;v=o}t=g/95;if(this.element.getContext){j=this.element.getContext("2d");this.clear(j);j.fillStyle=this.settings.color;k=this.settings.number&&this.settings.prefix?this.element.width*r.prefix_offset:0;w=h.split("");j.fillRect(k,0,t,o);k=k+t*2;j.fillRect(k,0,t,o);k=k+t;p=0;while(p<42){if(w[p]==="1"){j.fillRect(k,0,Math.floor(t)+1,v)}k=k+t;p++}k=k+t;j.fillRect(k,0,t,o);k=k+t*2;j.fillRect(k,0,t,o);k=k+t*2;p=42;while(p<84){if(w[p]==="1"){j.fillRect(k,0,Math.floor(t)+1,v)}k=k+t;p++}j.fillRect(k,0,t,o);k=k+t*2;j.fillRect(k,0,t,o);if(this.settings.number){j.font=r.font_size*v+"px monospace";q=this.number.substr(0,1);if(this.settings.prefix){j.fillText(q,0,o*r.font_y)}m=t*r.text_offset+(this.settings.prefix?r.prefix_offset*this.element.width:0);s=this.number.substr(1,6).split("");d.each(s,function(i,x){j.fillText(x,m,o*r.font_y);return m+=r.font_stretch*g});m=49*t+(this.settings.prefix?r.prefix_offset*this.element.width:0)+r.text_offset;d.each(this.number.substr(7).split(""),function(i,x){j.fillText(x,m,o*r.font_y);return m+=r.font_stretch*g})}if(this.settings.debug){for(u=l=0,n=t*2;n>0?l<=g:l>=g;u=l+=n){j.beginPath();j.rect(u,v*0.4,t,v*0.1);j.fillStyle="red";j.fill()}}return this.settings.onSuccess.call()}else{return this.settings.onError.call()}};f.prototype.generateCheckDigit=function(i){var h,g;g=0;h=i.split("");d.each(h,function(j,k){if(j%2===0){return g+=parseInt(k,10)}else{return g+=3*parseInt(k,10)}});g%=10;return g==0?0:10-g};f.prototype.validate=function(){return parseInt(this.number.slice(-1),10)===this.generateCheckDigit(this.number.slice(0,-1))};function f(h,j,g){var i;this.element=h;this.number=j;this.settings={number:true,prefix:true,color:"#000",debug:false,onValid:function(){},onInvalid:function(){},onSuccess:function(){},onError:function(){}};if(g){for(i in g){this.settings[i]=g[i]}}this._name=c;this.init()}return f})();return d.fn[c]=function(g,f){return this.each(function(){return d.data(this,"plugin_"+c,new e(this,g,f))})}})(jQuery,window,document);
